{% extends 'base2.html' %}
{% block title %}详细信息{% endblock %}
{% block row-left %}
<div id="accordion" role="tablist" aria-multiselectable="true">
	<div class="panel panel-default">
		<div class="panel-heading" role="tab" id="headingOne">
			<h4 class="panel-title">
				<a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">用户列表</a>
			</h4>
		</div>
		<div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
			<ul>
				<li>aaaa</li>
				<li>aaaa</li>
				<li>aaaa</li>
				<li>aaaa</li>
			</ul>
		</div>
	</div>
	<div class="panel panel-default">
		<div class="panel-heading" role="tab" id="headingTwo">
			<h4 class="panel-title">
				<a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">选择问卷</a>
			</h4>
		</div>
		<div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
			<ul>
				<li>aaaa</li>
				<li>aaaa</li>
				<li>aaaa</li>
				<li>aaaa</li>
			</ul>
		</div>
	</div>
</div>
<div class="btn-group btn-group-vertical" role="group">
	<button class='btn btn-info'><h3>生成问卷</h3></button><hr />
	<button class='btn btn-info' id='btnModify' onclick='info_modify(this)'><h3>修改资料</h3></button><hr />
	<button class='btn btn-info'><h3>添加记录</h3></button>
</div>
{% endblock %}
{% block row-right %}
<div class="row">
<div class='col-md-12'>
	<h2>{{ user.nickname }}</h2>
	<hr />
	<form id='form_details' action='' method='POST'>
	{% csrf_token %}
	<table class="table table-hover table-striped table-bordered">
		<thead class="thead-inverse">
			<tr id='trQuestion'>
				<th>属性</th>
				<th>值</th>
			</tr>
		</thead>
		<tbody id='tagTbInfo'>
		{% for question in user.questions.all %}
			<tr class='trAnswer'>
				<td>{{ question }}</td>
				<td><input class="form-control form-control-lg tagAnswer" name='tagAnswer' placeholder='属性值' type="text" value="{{ question.answers.last }}" readonly></td>
			</tr>
		{% endfor %}
			<tr class='error'>
				<td>111</td>
				<td>222</td>
			</tr>
			<tr>
				<td>333</td>
				<td>444</td>
			</tr>
		</tbody>
	</table>
	</form>
</div>
</div>
<div class='row hidden' id='tagBtnHidden'>
	<div class="col-md-4 col-md-offset-1 btn btn-primary" type='button' onclick='tagInfoAdd()'>增添信息</div>
	<input class="col-md-4 col-md-offset-2 btn btn-primary" form='form_details' type='submit' value='确认修改' onclick='modifyComfirm()'>
</div>
{% endblock %}
{% block script %}
<script>
function info_modify(e){
	// 禁用按钮
	e.setAttribute('disabled', 'true');
	// 修改资料
	var tagsAanswer = document.getElementsByClassName("tagAnswer");
	for(var i=0;i<tagsAanswer.length;i++){
		tagsAanswer[i].removeAttribute("readonly");
		var tagQuestion = tagsAanswer[i].parentNode.previousSibling.previousSibling
		tagQuestion.innerHTML = '\
		<fieldset class="form-group">\
			<input class="form-control form-control-lg" name="tagQuestion" type="text" placeholder="新属性名" list="attrOption"\
			onblur="questionJudge(this)" value="' + tagQuestion.innerHTML + '">\
			<datalist id="attrOption">\
			{% for attr in attrs %}\
				<option value="{{ attr.attr }}">\
			{% endfor %}\
			</datalist>\
		</fieldset>'
	};
	// 显示隐藏按钮
	var tagBtnHidden = document.getElementById("tagBtnHidden");
	var classVal = tagBtnHidden.getAttribute("class");
	classVal = classVal.replace('hidden', '');
	tagBtnHidden.setAttribute("class", classVal);
	// 新增删除列表头
	var tagTrQuestion = document.getElementById('trQuestion');
	var tagThNew = document.createElement('th');
	tagTrQuestion.appendChild(tagThNew);
	tagThNew.setAttribute('id', 'delInfo');
	tagThNew.innerHTML = '删除';
	// 新增删除列
	var tagsTrAnswer = document.getElementsByClassName('trAnswer');
	for(var i=0;i<tagsTrAnswer.length;i++){
		var tagTdNew = document.createElement('td');
		tagsTrAnswer[i].appendChild(tagTdNew);
		tagTdNew.innerHTML = '<input class="form-control form-control-lg btn-danger btn" type="button" value="X">';
	};
};

function questionJudge(e){
	// 提供备选答案
	{% for attr in attr_option %}
		if('{{ attr.attr }}'==e.value){
			e.parentNode.parentNode.nextSibling.nextSibling.innerHTML='\
			<fieldset class="form-group">\
				<input class="form-control form-control-lg" name="tagAnswer" type="text" placeholder="属性值" list="valueOptions">\
				<datalist id="valueOptions">\
				{% for value in attr.options.all %}\
					<option value="{{ value }}">\
				{% endfor %}\
				</datalist>\
			</fieldset>'
		};
	{% endfor %}
};

function tagInfoAdd(){
	// 添加新属性
	var tagTbInfo = document.getElementById('tagTbInfo');
	var tagTrNew = document.createElement('tr');
	tagTbInfo.appendChild(tagTrNew);
	tagTrNew.setAttribute('class', 'trAnswer');
	tagTrNew.innerHTML = '\
	<td>\
		<fieldset class="form-group">\
			<input class="form-control form-control-lg" name="tagQuestion" type="text" placeholder="新属性名" list="attrOption" onblur="questionJudge(this)">\
			<datalist id="attrOption">\
			{% for attr in attrs %}\
				<option value="{{ attr.attr }}">\
			{% endfor %}\
			</datalist>\
		</fieldset>\
	</td>\
	<td><input class="form-control form-control-lg tagAnswer" name="tagAnswer" type="text" placeholder="属性值"></td>\
	<td><input class="form-control form-control-lg btn-danger btn" type="button" value="X"></td>'
};
function modifyComfirm(){
	document.getElementById("form_details").onsubmit = function(e){
		e.preventDefault();
		var f = e.target,
			formData = new FormData(f),
			xhr = new XMLHttpRequest(),
			para = document.getElementById('row-right'),
			btnModify = document.getElementById('btnModify');
		xhr.open("POST", f.action, true);
		xhr.onreadystatechange=function(){
			if(xhr.readyState == 4 && xhr.status == 200){
				var rowNew = xhr.responseText;
				para.innerHTML = rowNew;
			};
		};
		xhr.send(formData);
		btnModify.removeAttribute('disabled');
	};
}
</script>
{% endblock %}
