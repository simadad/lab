{% extends 'base2.html' %}
{% block title %}用户列表{% endblock %}
{% block userList %}active{% endblock %}
{% block row-left %}
<button class='btn btn-info btn-block btn-lg' data-toggle="modal" data-target="#dialogModal">添加成员</button>
<div class="modal fade" id='dialogModal' tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">添加成员：</h4>
			</div>
			<div class="modal-body">
				<form class="form-horizontal" id='formUserAdd' action='' method='POST'>
					{% csrf_token %}
					<table class="table table-hover table-striped">
						<thead>
							<tr>
								<th class='col-md-6 text-center'>昵称</th>
								<th class='col-md-5 text-center'>微信</th>
								<th class='col-md-1 text-center'>删除</th>
							</tr>
						</thead>
						<tbody id='tagTbInfo'>
							<tr>
								<td><input class="form-control input-lg" name="nickname" onfocus="this.select();" required=true placeholder='昵称'></td>
								<td><input class="form-control input-lg" name='wechat' onfocus="this.select();" required=true placeholder='微信'></td>
								<td><input class="form-control input-lg btn btn-danger" type="button" value="X" onclick='delTR(this)'></td>
							</tr>
						</tbody>
					</table>
				</form>
				<button class='btn btn-info btn-block btn-xs' onclick='userMore()'>▼</button>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" id='btn-modal-hide' data-dismiss="modal">取消</button>
				<button type="submit" class="btn btn-primary" form='formUserAdd' onclick='userSave()'>保存</button>
			</div>										
		</div>
	</div>
</div>
{% endblock %}
{% block row-right %}
<table class="table table-hover table-striped table-bordered">
	<caption>成员列表</caption>
		<thead class='thead-inverse'>
		<tr>
			<th>昵称</th>
			<th>微信</th>
			<th>问卷</th>
			<th>入学日期</th>
		</tr>
		</thead>
	<tbody id='userList'>
	{% for lab_user in users %}
		<tr>
			<td><a href='{% url "crm:detail" %}?uid={{ lab_user.id }}'>{{ lab_user.nickname }}</a></td>
			<td>{{ lab_user.wechat }}</td>
			<td>
			{% if lab_user.papers %}
				<a>{{ lab_user.papers.last }}</a>
			{% else %}
				<a>None</a>
			{% endif %}
			</td>
			<td>{{ lab_user.user.date_joined }}</td>
		</tr>
	{% endfor %}
		<div class='newUser'>
		</div>
	</tbody>
</table>
{% endblock %}
{% block script %}
<script>
function userSave(){
	// 保存新用户
	document.getElementById("formUserAdd").onsubmit = function(e){
		e.preventDefault();
		var f = e.target,
			formData = new FormData(f),
			xhr = new XMLHttpRequest(),
			para = document.getElementById('userList');
		xhr.open("POST", f.action, true);
		xhr.onreadystatechange=function(){
			if(xhr.readyState == 4 && xhr.status == 200){
				var rowNew = xhr.responseText;
				para.insertAdjacentHTML('afterbegin', rowNew);
				document.getElementById('btn-modal-hide').click();
			};
		};
		xhr.send(formData);
	};
};
function userMore(){
	// 更多新用户
	var para = document.getElementById('tagTbInfo'),
		tr = document.createElement('tr');
	tr.innerHTML = '\
	<td><input class="form-control input-lg" name="nickname" onfocus="this.select();" required=true placeholder="昵称"></td>\
	<td><input class="form-control input-lg" name="wechat" onfocus="this.select();" required=true placeholder="微信"></td>\
	<td><input class="form-control input-lg btn btn-danger" type="button" value="X" onclick="delTR(this)"></td>'
	para.appendChild(tr);
};
function delTR(e){
	var tr = e.parentElement.parentElement;
	tr.parentElement.removeChild(tr);
};

</script>
{% endblock %}